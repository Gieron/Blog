<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>LINQ: I only speak in SQL | Pseudorandom Knowledge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/styles/highlight.css" />
    <link rel="stylesheet" href="/styles/common.css" />
    <script src="/scripts/highlight.js"></script>
    <script src="/scripts/common.js"></script>
</head>
<body>
    <header>
        <a href="/" rel="home">
            <h1>Pseudorandom Knowledge</h1>
        </a>
    </header>

    <article itemscope itemtype="http://schema.org/BlogPosting">
        <header>
            <h1 itemprop="headline name">LINQ: I only speak in SQL</h1>
            <time class="published" itemprop="datePublished">2011-10-03</time>
            <time class="modified" itemprop="dateModified">2017-09-05</time>
        </header>

        <content itemprop="articleBody text">

            <p>
                <a href="https://msdn.microsoft.com/library/bb425822.aspx">LINQ to SQL</a> (Language Integrated Query to Structured Query Language) is probably the best known use of LINQ. It gives us an easy to use way of communicating with SQL databases.
            </p>

            <pre><code class="sql">CREATE TABLE People (
  Id INT IDENTITY,
  Age INT NULL,
  Name VARCHAR(50) NULL
);</code></pre>

            <p>
                First we create a simple table in our database. Out of the box LINQ to SQL only supports SQL Server but you can use LINQ to DataSet or <a href="https://en.wikipedia.org/wiki/Language_Integrated_Query#LINQ_providers">other LINQ providers</a> to get around this.
            </p>

            <pre><code class="csharp">[Table(Name = "People")]
public class Person
{
    [Column(IsPrimaryKey = true, IsDbGenerated = true)]
    public int Id;
    [Column]
    public int Age;
    [Column]
    public string Name;
}</code></pre>

            <p>
                In the code we then create a class that the table can be mapped against. We use attributes to tell LINQ that the class represents a table. In this case we also tell it the table name since it’s different from the class name. It makes sense to name tables in plural and classes in singular. In order for LINQ to work properly the table must have a primary key, which in this case is generated by the database.
            </p>

            <p>
                Visual Studio can generate this class for us, or it can generate the database from the class or even both of them from a schema. In this case I have created both the class and the table manually.
            </p>

            <pre><code class="csharp">DataContext database = new DataContext(
    @"Data Source     = 127.0.0.1,15096;
      Network Library = DBMSSOCN;
      Initial Catalog = linqtest;
      User Id         = sa;
      Password        = hunter2;");
Table&lt;Person> people = database.GetTable<Person>();</code></pre>

            <p>
                Before we can use the database we must connect to it. We do this by creating a new <em><a href="https://msdn.microsoft.com/en-us/library/system.data.linq.datacontext.aspx">DataContext</a></em> and giving it a connection string. The <em>DataContext</em> takes care of connecting to the database as needed. It also keeps track of changes which we will come to later.
            </p>

            <p>
                We must also create a table object in order to have something to query against. In practice you should create a <a href="https://msdn.microsoft.com/library/bb425822.aspx#linqtosql_topic4">strongly typed <em>DataContext</em></a> instead. That is, a class which inherits from <em>DataContext</em> and declares all tables as public fields.
            </p>

            <pre><code class="csharp">from p in people select p.Age + " " + p.Name
"28 Edgar", "34 Marit", "14 Trulf"
from p in people orderby p.Age select p.Age + " " + p.Name
"14 Trulf", "28 Edgar", "34 Marit"
people.Where(p => p.Age > 20).Select(p => p.Age + " " + p.Name)
"28 Edgar", "34 Marit"</code></pre>

            <p>
                We can now use LINQ to run queries against the table. These queries are translated to <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/expression-trees/index">expression trees</a> which are in turn translated to SQL and run against the database.
            </p>

            <pre><code class="csharp">foreach (Person p in people)
    p.Age++;
database.SubmitChanges();
 
from p in people orderby p.Age select p.Age + " " + p.Name
"15 Trulf", "29 Edgar", "35 Marit"</code></pre>

            <p>
                Part of the <em>DataContext</em>’s responsibilities is to keep track of changes to objects that correspond to table rows. Because of this we can make our changes permanent by submitting them to the database.
            </p>

            <pre><code class="csharp">Person alan = new Person() { Age = 41, Name = "Alan" };
people.InsertOnSubmit(alan);
Person marit = people.Single(p => p.Name == "Marit");
people.DeleteOnSubmit(marit);
database.SubmitChanges();

people.Select(p => p.Name)
"Edgar", "Trulf", "Alan"</code></pre>

            <p>
                Naturally, we can also add or remove rows from the table. This also requires that we submit our changes. If you create <a href="https://msdn.microsoft.com/library/bb425822.aspx#linqtosql_topic5">associations to other tables</a> additions and removals will be tracked automatically.
            </p>

        </content>

        <footer>
            <a class="comment" itemprop="discussionUrl" href="https://github.com/Gieron/Blog/issues/new" target="_blank">Have an issue with the post?</a>
            <span class="author" itemprop="author">Henrik Ripa</span>
        </footer>
    </article>

    <footer></footer>
</body>
</html>